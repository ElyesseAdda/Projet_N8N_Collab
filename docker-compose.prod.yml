services:
  # 1. Le Proxy (Traefik) - Le chef d'orchestre
  traefik:
    image: traefik:latest
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      # Configuration HTTPS avec Let's Encrypt
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=zonia.ai.pro@gmail.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Redirection automatique HTTP vers HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard Traefik (√† s√©curiser en production)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
    labels:
      - "traefik.enable=true"

  # 2. Ton Portail Node.js
  mon-portail:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - ./mon-portail:/app
      - portail_node_modules:/app/node_modules
    command: sh -c "npm install && npm run build && NODE_ENV=production exec node server.js"
    environment:
      # URL de l'API n8n (accessible via le nom du service Docker)
      - N8N_API_URL=http://n8n:5678
      # Cl√© API n8n pour authentifier les requ√™tes
      # üîë IMPORTANT : V√©rifiez que cette cl√© est bien celle de votre compte entreprise
      - N8N_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwYWJlYmU1NS04Y2RkLTRkODUtOTc5ZC0yMWFhNGU5Mjk1MjIiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzY1NjQyMTAwLCJleHAiOjE3NjgxOTQwMDB9.k-zrpH0z7UlfdnqSM1OEGtS0MuwzTT1VyGhCl-EUon4
      # Forcer HTTPS pour activer les headers de s√©curit√© (Cross-Origin-Opener-Policy, etc.)
      - FORCE_HTTPS=true
      - SECURE_COOKIES=true
    # Les ports 3000 et 5173 ne sont plus n√©cessaires car on passe par Traefik
    labels:
      - "traefik.enable=true"
      # Configuration pour le domaine zoniahub.fr
      # IMPORTANT: Priorit√© plus basse que n8n pour laisser /n8n passer en premier
      # Router HTTP (redirige vers HTTPS) - Exclut /n8n pour que Traefik route vers n8n
      - "traefik.http.routers.portail.rule=(Host(`zoniahub.fr`) || Host(`www.zoniahub.fr`)) && !PathPrefix(`/n8n`)"
      - "traefik.http.routers.portail.entrypoints=web"
      - "traefik.http.routers.portail.priority=10"
      # Router HTTPS (principal) - Exclut /n8n
      - "traefik.http.routers.portail-secure.rule=(Host(`zoniahub.fr`) || Host(`www.zoniahub.fr`)) && !PathPrefix(`/n8n`)"
      - "traefik.http.routers.portail-secure.entrypoints=websecure"
      - "traefik.http.routers.portail-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.portail-secure.priority=10"
      - "traefik.http.services.portail.loadbalancer.server.port=3000"
    depends_on:
      n8n:
        condition: service_started
    restart: unless-stopped

  # 3. La base de donn√©es Postgres
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_USER=n8n
      # ‚ö†Ô∏è IMPORTANT : Changez ce mot de passe en production !
      # Utilisez un mot de passe fort et s√©curis√© (min 16 caract√®res recommand√©)
      - POSTGRES_PASSWORD=Ayla220223@@
      - POSTGRES_DB=n8n
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    # Ne pas exposer le port PostgreSQL publiquement en production
    # ports:
    #   - "5432:5432"

  # 4. n8n
  n8n:
    image: n8nio/n8n:latest
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=Ayla220223@@
      
      # CONFIGURATION POUR LA PRODUCTION
      # Domaine configur√© : zoniahub.fr
      - N8N_HOST=zoniahub.fr
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_PATH=/n8n/
      - N8N_EDITOR_BASE_URL=https://zoniahub.fr/n8n/
      - WEBHOOK_URL=https://zoniahub.fr/n8n/
      
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_USER_MANAGEMENT_DISABLED=true
      - N8N_TRUST_PROXY=true
      # Cookies s√©curis√©s activ√©s en HTTPS
      - N8N_SECURE_COOKIE=true
      # Permettre les requ√™tes cross-origin depuis le portail
      - N8N_CORS_ORIGIN=*
      # Configuration recommand√©e pour √©viter les warnings
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false
      
      # Configuration pour les fonctions Node.js
      # Autoriser l'utilisation du module xlsx dans les fonctions Node.js
      - NODE_FUNCTION_ALLOW_EXTERNAL=xlsx
      
      # Configuration du timezone (exemple: Europe/Paris, UTC, America/New_York, etc.)
      # Remplacez par le timezone souhait√© selon votre localisation
      - TZ=Europe/Paris
      
      # CL√â DE CHIFFREMENT
      # ‚ö†Ô∏è IMPORTANT : Utilisez une cl√© s√©curis√©e unique
      # G√©n√©rer avec : openssl rand -base64 32 (sur Linux) ou generate-encryption-key.ps1 (sur Windows)
      - N8N_ENCRYPTION_KEY=vzzLSkyJmYtc4wOlzRsJp36aSwMQb2ytun2dfVp0m5k=
    labels:
      - "traefik.enable=true"
      
      # --- D√âFINITION DU MIDDLEWARE DE S√âCURIT√â ---
      # On cr√©e un middleware qui ajoute les headers n√©cessaires pour la compatibilit√© COEP
      # Cross-Origin-Embedder-Policy=require-corp : n8n accepte d'√™tre charg√©e par un parent strict
      - "traefik.http.middlewares.n8n-security.headers.customresponseheaders.Cross-Origin-Embedder-Policy=require-corp"
      - "traefik.http.middlewares.n8n-security.headers.customresponseheaders.Cross-Origin-Opener-Policy=same-origin"
      - "traefik.http.middlewares.n8n-security.headers.customresponseheaders.Cross-Origin-Resource-Policy=same-site"
      - "traefik.http.middlewares.n8n-security.headers.customresponseheaders.X-Frame-Options=SAMEORIGIN"
      
      # Middleware pour retirer le pr√©fixe /n8n
      - "traefik.http.middlewares.n8n-strip.stripprefix.prefixes=/n8n"
      
      # Router HTTP (redirige vers HTTPS)
      - "traefik.http.routers.n8n.rule=(Host(`zoniahub.fr`) || Host(`www.zoniahub.fr`)) && PathPrefix(`/n8n`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.routers.n8n.priority=200"
      - "traefik.http.routers.n8n.middlewares=n8n-strip"
      
      # Router HTTPS (principal)
      - "traefik.http.routers.n8n-secure.rule=(Host(`zoniahub.fr`) || Host(`www.zoniahub.fr`)) && PathPrefix(`/n8n`)"
      - "traefik.http.routers.n8n-secure.entrypoints=websecure"
      - "traefik.http.routers.n8n-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-secure.priority=200"
      
      # --- ACTIVATION DES MIDDLEWARES ---
      # On applique les middlewares au router HTTPS (strip puis security)
      - "traefik.http.routers.n8n-secure.middlewares=n8n-strip,n8n-security"
      
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

networks:
  default:
    name: n8n-network
    driver: bridge

volumes:
  db_data:
  portail_node_modules:

